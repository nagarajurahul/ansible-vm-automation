# https://docs.ansible.com/ansible/latest/collections/kubernetes/core/k8s_module.html
- name: Create a Namespace for ArgoCD
  kubernetes.core.k8s:
    name: argocd
    api_version: v1
    kind: Namespace
    state: present

- name: Download ArgoCD manifests
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
    dest: /tmp/argocd-install.yaml

- name: Apply ArgoCD manifests
  kubernetes.core.k8s:
    src: /tmp/argocd-install.yaml
    state: present



- name: Get the list of ArgoCD pods in the argocd namespace
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: argocd
  register: argocd_pods

- name: Wait till the Pods are running
  kubernetes.core.k8s_info:
    kind: Pod
    wait: yes
    name: "{{ item.metadata.name }}"
    namespace: argocd
    register: pod_status
    until: pod_status.resources[0].status.phase == "Running"
    retries: 30
    delay: 5
    loop: "{{ argocd_pods.resources }}"