---
# https://docs.ansible.com/ansible/latest/collections/kubernetes/core/index.html
# https://metallb.universe.tf/installation/

# Update here regularly to match the latest MetalLB version
- name: Download MetalLB manifests
  ansible.builtin.get_url:
    url: "https://raw.githubusercontent.com/metallb/metallb/{{ metallb_version }}/config/manifests/metallb-native.yaml"
    dest: /tmp/metallb-install.yaml
    mode: '0644'

- name: Install MetalLB
  kubernetes.core.k8s:
    state: present
    src: /tmp/metallb-install.yaml
    kubeconfig: "{{ kubeconfig_path }}"
  register: metallb_install

- name: Check if memberlist secret exists
  kubernetes.core.k8s_info:
    kind: Secret
    name: memberlist
    namespace: "{{ metallb_namespace }}"
  register: memberlist_secret

- name: Create memberlist secret (one-time)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: memberlist
        namespace: "{{ metallb_namespace }}"
      type: Opaque
      stringData:
        secretkey: "{{ lookup('password', '/dev/null length=128 chars=ascii_letters') }}"
  when: memberlist_secret.resources | length == 0
  no_log: true

# Wait for MetalLB to be ready before applying the configuration
- name: Wait for MetalLB to stabilize
  ansible.builtin.pause:
    seconds: 60

- name: Render MetalLB address pool config
  ansible.builtin.template:
    src: metallb-config.yaml.j2
    dest: /tmp/metallb-config.yaml
    mode: '0644'

- name: Apply MetalLB address pool config
  kubernetes.core.k8s:
    state: present
    src: /tmp/metallb-config.yaml
    kubeconfig: "{{ kubeconfig_path }}"

- name: Wait for all MetalLB pods to be Running
  ansible.builtin.shell: |
    kubectl get pods -n {{ metallb_namespace }} --no-headers | awk '{print $2}' | grep -vE "^[0-9]+/[0-9]+$" && exit 1 || exit 0
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: metallb_ready
  retries: 30
  delay: 10
  until: metallb_ready.rc == 0
  when: "'masters' in group_names"
  become_user: "{{ ansible_user }}"

- name: Get MetalLB pods
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: metallb-system
    kubeconfig: "{{ kubeconfig_path }}"
  register: metallb_pods

- name: Show MetalLB pod names and statuses
  ansible.builtin.debug:
    msg: "{{ metallb_pods.resources | map(attribute='metadata.name') | list }}"
